# 工作流编排

适宜流程固定（有固定的几步）、大批量重复（数十个或者数百个起步）、复用部分单元需求强（部分步骤可以通用或者部分场景复用）的场景，比如网页爬虫、数据分析、自动化测试等。

## 使用场景

目前内部有三类场景预期需要用工作流编排：
1. 数据服务业务，科研客户的网页爬虫项目及其交付。
2. 课堂业务，作业题以自动化测试流程检测。
3. 日常经营，业务数据分析。

下面分别介绍三类场景。

### 网页爬虫

网页爬虫一般分为以下几步：
1. 调度：主要是确定清单的分配、搜索引擎式广度优先遍历等情况，可以根据不同的情况用一个或者数个API接口解决。
2. 请求：主要是处理反爬逻辑，反爬逻辑大体可以通用，因此可以用一个或者数个API接口解决。
3. 解析：对于每个网站的情况都不一样，需要根据具体项目需求定制。
4. 存储：处理SQL-like或者NoSQL-like数据到指定存储（i.e. CynosDB/MySQL，云开发云数据库/MongoDB、对象存储/云开发云存储）。对于每一类数据需要提供一个API接口。

可能的迭代过程如下：
1. 新项目1，我们创建了调度、请求、解析、存储四个云函数，并且为爬虫定制了一套工作流模板方便复用。
2. 新项目2，我们发现调度逻辑需要修复Bug以后即可复用，请求反爬逻辑需要进一步迭代复杂化，存储需要一种新的类型，对工作流同时也需要稍微调整一下支持不同的存储API。
3. 对于新项目3、4、...、N，重复上述迭代过程。

这样的好处是：
1. 符合云原生原则之一的“基于API的协作”，相比于存储服务本身的复杂接口（以及腾讯云晦涩难懂的文档带来的额外学习成本），二次封装以后的API接口更加贴合现在的固定场景，更加方便使用。
2. 符合敏捷的迭代原则，一步一步搭建通用性强的爬虫框架以提高后续工作效率和可靠性。
3. 基于工作流复用和约束流程，同时还复用了通用单元。
4. 云函数本身的事件函数机制，可以用来自动化做异步调度管理，无需开发者在Python内部实现相对复杂的异步逻辑。

### 自动化测试

自动化测试一般是分为以下几步：
1. 静态测试。主要是代码自动化静态检测，每个语言有自己的一套规范和对应方案，针对语言分类处理即可，可以使用一个或者数个API接口解决。
2. 动态测试，主要是单元测试。每个项目需要定制。
3. Code Review。通常是人工审核，提供一个通用引擎即可，也可做在App系统里。

### 数据分析

数据分析一般是分为以下几步：
1. 预处理。需要根据不同的需求做一系列定制化处理，也有可能需要缓存中间数据用于不同的分析需求甚至持久化。
2. 模型。需要使用不同的数据做同一个模型，或者同一个数据做不同模型。
3. 可视化。需要使用不同的模型和统计做同一个表，或者不同的表做同一组数据和模型对比。不过一般在前端，后端需要做的事情不太多。
